name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-wasm:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Install wasm-pack
        uses: jetli/wasm-pack-action@v0.4.0
        with:
          version: 'latest'

      - name: Build Wasm
        working-directory: ./app
        run: wasm-pack build --target web

      - name: Prepare Distribution
        run: |
          mkdir dist
          cp app/www/index.html dist/
          cp -r app/pkg dist/
          if [ -f "LICENSE" ]; then cp LICENSE dist/; fi
          zip -r evo-sim-${{ github.ref_name }}-web.zip dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: evo-sim-${{ github.ref_name }}-web.zip
          generate_release_notes: true
